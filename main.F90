PROGRAM MAIN
  INTEGER :: NPROMA, LAST_BLK_NPROMA, NFLEV, NBLKS, GRID, NSTEPMAX
  CHARACTER(LEN=8) :: ARG
  LOGICAL :: FILE_EXIST

  IF(COMMAND_ARGUMENT_COUNT() /= 2)THEN
      CALL USAGE()
    STOP 1
  ENDIF

  INQUIRE(FILE="DATA/ACVPPKF.IN.DAT", EXIST=FILE_EXIST)
  IF(.NOT. FILE_EXIST)THEN
    WRITE(*,*)"COULDN'T FIND INPUT FILE DATA/ACVPPKF.IN.DAT"
    STOP 1
  ENDIF
  INQUIRE(FILE="DATA/ACVPPKF.OUT.DAT", EXIST=FILE_EXIST)
  IF(.NOT. FILE_EXIST)THEN
    WRITE(*,*)"COULDN'T FIND INPUT FILE DATA/ACVPPKF.OUT.DAT"
    STOP 1
  ENDIF
  INQUIRE(FILE="DATA/ACVPPKF.CONST.DAT", EXIST=FILE_EXIST)
  IF(.NOT. FILE_EXIST)THEN
    WRITE(*,*)"COULDN'T FIND INPUT FILE DATA/ACVPPKF.CONST.DAT"
    STOP 1
  ENDIF

  CALL GET_COMMAND_ARGUMENT(1, ARG)
  READ(ARG, *) NPROMA
  CALL GET_COMMAND_ARGUMENT(2, ARG)
  READ(ARG, *) NSTEPMAX

  CALL GET_GRID_AND_NFLEV(GRID, NFLEV)
  IF(MOD(GRID, NPROMA) ==0)THEN
    NBLKS=GRID/NPROMA
    LAST_BLK_NPROMA=NPROMA
  ELSE
    NBLKS=GRID/NPROMA +1
    LAST_BLK_NPROMA=MOD(GRID, NPROMA)
  ENDIF

  WRITE(*,*)"NSTEPMAX:", NSTEPMAX
  WRITE(*,*)"GRID SIZE:",GRID
  WRITE(*,*)"NPROMA:", NPROMA
  WRITE(*,*)"NBLKS:",NBLKS
  WRITE(*,*)"NPROMA OF LAST BLOCK", LAST_BLK_NPROMA

  CALL WRAP_ACVPPKF(NSTEPMAX, NPROMA, LAST_BLK_NPROMA, NFLEV, NBLKS, GRID)
END PROGRAM MAIN

SUBROUTINE GET_GRID_AND_NFLEV(GRID, NFLEV)
  IMPLICIT NONE
  INTEGER, INTENT(OUT) :: GRID, NFLEV
  INTEGER :: FH, CHECK
  INTEGER, PARAMETER :: CHECK_VAL = 123456789
  OPEN (NEWUNIT=FH, FILE="DATA/ACVPPKF.CONST.DAT", ACTION="READ", ACCESS="STREAM")
  READ(FH)CHECK
  IF(CHECK /= CHECK_VAL)WRITE(*,*)__LINE__,"WRONG CONTROL NUMBER",CHECK
  READ(FH)GRID
  READ(FH)NFLEV
  CLOSE(FH)
END SUBROUTINE GET_GRID_AND_NFLEV

SUBROUTINE USAGE()
  WRITE(*,*)"USAGE: ./MAIN.X NPROMA NSTEPMAX"
  WRITE(*,*)"NPROMA: THE IDEAL NUMBER OF POINTS PER BLOCK"
  WRITE(*,*)"NSTEPMAX: THE NUMBER OF STEP TO RUN THE SIMULATION"
END SUBROUTINE USAGE
